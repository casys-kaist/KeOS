use kev::vm::VmBuilder;
use kev_project2::simple_ept_vm::SimpleEptVmState;

// print 'Hello mmio!\n' and exit.
// #[stdin(b"")]
// #[assert_output(b"Hello mmio!\n")]
pub fn mmio_print() {
    let vm = VmBuilder::new(
        SimpleEptVmState::new(&[
            0x48, 0xB8, 0x00, 0x00, 0xFE, 0xCA, 0x00, 0x00, 0x00,
            0x00, // movabs rax,0xcafe0000
            0x48, 0x8D, 0x1D, 0x36, 0x00, 0x00, 0x00, //  lea    rbx,[rip+0x36]
            0x48, 0x89, 0x18, // mov    QWORD PTR [rax],rbx
            0x48, 0xB8, 0x08, 0x00, 0xFE, 0xCA, 0x00, 0x00, 0x00,
            0x00, // movabs rax,0xcafe0008
            0x48, 0xC7, 0x00, 0x0C, 0x00, 0x00, 0x00, // mov    QWORD PTR [rax],0xc
            0x48, 0xB8, 0x10, 0x00, 0xFE, 0xCA, 0x00, 0x00, 0x00,
            0x00, // movabs rax,0xcafe0010
            0x48, 0xC7, 0x00, 0x01, 0x00, 0x00, 0x00, // mov    QWORD PTR [rax],0x1
            0x48, 0xC7, 0xC7, 0x00, 0x00, 0x00, 0x00, // mov    rdi,0x0
            0x48, 0xC7, 0xC0, 0x00, 0x00, 0x00, 0x00, // mov    rax,0x0
            0x0F, 0x01, 0xC1, // vmcall
            // .byte
            0x48, 0x65, 0x6C, 0x6C, 0x6F, 0x20, 0x6D, 0x6D, 0x69, 0x6F, 0x21, 0x0A,
        ]),
        1,
    )
    .expect("Failed to create vmbuilder.")
    .finalize()
    .expect("Failed to create vm.");

    vm.start_bsp().expect("Failed to start bsp.");
    assert_eq!(vm.join(), 0);
}
